<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Cover Letter Generator</title>
    <link href="styles.css" rel="stylesheet" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.debug.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.2/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/vfs_fonts.js"></script>
</head>
<body>
<div class="form">
    <h1>AI Cover Letter Generator</h1>
    <div class="form-section">
        <label for="resume">Select your resume</label>
        <input accept=".pdf" id="resume" name="pdfFile" type="file">
    </div>
    <div class="form-section">
        <label for="jobUrl">Enter Job post url</label>
        <input id="jobUrl" placeholder="Example: https://www.join.com/software-engineer" type="text">
    </div>
    <br>
    <br>
    <div class="form-section">
        <label for="coverLetter">Generated Cover Letter</label>
        <textarea id="coverLetter"></textarea>
    </div>
    <button id="exportAsPDF">Download as PDF</button>
    <button id="generateCoverLetter">Generate</button>
</div>

<script>

    var resume = "Empty"



    document.getElementById('resume').addEventListener('change', async (event) => {
        const file = event.target.files[0];

        if (file) {
            const fileReader = new FileReader();
            fileReader.onload = async (e) => {
                const pdfData = new Uint8Array(e.target.result);
                const extractedText = await extractTextFromPdf(pdfData);
                resume = extractedText
                console.log(resume)
            };
            fileReader.readAsArrayBuffer(file);
        }
    });



    document.getElementById('generateCoverLetter').addEventListener('click', async () => {
        // const jobDescriptionText = await extractJobDescription();
        const urlInput = document.getElementById('jobUrl');
        const url = urlInput.value.trim();
        const coverLetter = await  askChatGPTToGenerateCoverACoverLetter(resume , url)
        document.getElementById('coverLetter').value = coverLetter
    });

    document.getElementById('exportAsPDF').addEventListener('click',()=>{
        generatePDF(document.getElementById('coverLetter').value)

    })


    function generatePDF(text) {
        // Define the content of the PDF document
        var docDefinition = {
            pageSize: 'A4',
            content: [
                { text: text, fontSize: 12, margin: [0, 50, 0, 0] } // Add margin to the top
            ]
        };

        // Generate the PDF file using pdfmake
        pdfMake.createPdf(docDefinition).download();
    }


    async function extractTextFromPdf(pdfData) {
        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
        let extractedText = '';

        for (let pageIndex = 1; pageIndex <= pdf.numPages; pageIndex++) {
            const page = await pdf.getPage(pageIndex);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join('\n');
            extractedText += pageText + '\n';
        }

        return extractedText;
    }
</script>


<script>
    const API_URL = "https://lighthearted-puppy-fc68cb.netlify.app/api/v1/cover-letter";
    async function askChatGPTToGenerateCoverACoverLetter(resumeText , jobUrl) {

        const response = await fetch(API_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                resumeText: resumeText,
                jobUrl: jobUrl,
            }),
        });

        if (!response.ok) {
            throw new Error("Failed to call Chat GPT API");
        }

        const data = await response.json();
        const firstText = data.coverLetter;
        console.log(firstText);
        return firstText;
    }
</script>

</body>
</html>